# Task 07: Circuit Breaker and Connection Pool Configuration

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create DestinationRule with Connection Pool and Outlier Detection

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: echo-ds
  namespace: brown
spec:
  host: brown-echo
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 1
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 3
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 5s
      baseEjectionTime: 5m
EOF
```
### Step 3: Create VirtualService

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: echo-vs
  namespace: brown
spec:
  hosts:
  - brown-echo
  http:
  - match:
      - uri:
          prefix: /
    route:
      - destination:
          host: brown-echo.brown.svc.cluster.local
          port:
            number: 8080
EOF
```

### Step 4: Verify Configuration

```bash
# Check DestinationRule exists
kubectl get destinationrule -n brown

# View DestinationRule details
kubectl get destinationrule echo-ds -n brown -o yaml

# Check VirtualService exists
kubectl get virtualservice -n brown
```

## Testing with Fortio

Fortio is a load testing tool included in the task setup. Use it to test connection pool and circuit breaker behavior.

### Test 1: Verify Connection Pool Limits

```bash
# Get Fortio pod name
FORTIO_POD=$(kubectl get pod -n brown -l app=fortio -o jsonpath='{.items[0].metadata.name}')

# Test with 10 concurrent connections, 100 requests total
kubectl exec $FORTIO_POD -n brown -- fortio load \
  -c 10 \
  -n 100 \
  http://brown-echo/mars
```

**Expected output:**
```
Code 200: ~60-70 (successful requests)
Code 503: ~30-40 (connection pool overflow)
```

**What to look for:**
- `Code 200`: Successful requests within connection limits
- `Code 503`: Failed requests due to connection pool overflow
- With `maxConnections: 1` and `http1MaxPendingRequests: 10`, capacity is limited

### Test 2: More Aggressive Load Test

```bash
# Test with 20 concurrent connections, no QPS limit
kubectl exec $FORTIO_POD -n brown -- fortio load \
  -c 20 \
  -qps 0 \
  -n 200 \
  http://brown-echo/mars
```

**Expected behavior:**
- Higher percentage of 503 errors with `maxConnections: 1`
- Only 1 TCP connection allowed to backend
- Requests queue up to `http1MaxPendingRequests: 10`
- Requests beyond capacity get 503

### Test 3: Check Circuit Breaker with /pluto

```bash
# Generate 5xx errors to trip circuit breaker
kubectl exec $FORTIO_POD -n brown -- fortio load \
  -c 20 \
  -n 50 \
  http://brown-echo/blackhole
```

**Expected output:**
```
Code 500: ~10 (initial 5xx errors from backend)
Code 503: ~30 (circuit breaker open - rejected by Envoy)
```

**Circuit breaker behavior:**
- After 3 consecutive 5xx errors â†’ circuit opens
- Subsequent requests fail immediately with 503 (no backend attempt)
- Endpoint ejected for `baseEjectionTime: 5m`
