# Task 05: Configure Retry Policy for HTTP Errors

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create VirtualService with Retry Policy

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: gray-echo-vs
  namespace: gray
spec:
  hosts:
    - gray-echo
  http:
    - retries:
        attempts: 2
        perTryTimeout: 1s
        retryOn: 5xx
      route:
        - destination:
            host: gray-echo.gray.svc.cluster.local
            port:
              number: 80
EOF
```

### Step 3: Verify Configuration

```bash
# Check VirtualService exists
kubectl get virtualservice -n gray
```

## Testing

### Test 1: Trigger Retries with 500 Error

```bash
# Run a test pod
kubectl exec sleep-red -n red -- curl -s -o /dev/null -w "%{http_code}\n"  http://gray-echo.gray.svc.cluster.local/blackhole

kubectl logs -n gray -l app=gray-echo -c istio-proxy | grep 'HTTP/1.1" 500'

```
