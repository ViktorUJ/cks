# Task 08: Traffic Mirroring (Shadowing)

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create VirtualService with Traffic Mirroring

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: platinum-vs
  namespace: platinum
spec:
  hosts:
  - platinum-echo
  http:
  - match:
      - uri:
          prefix: /
    route:
      - destination:
          host: platinum-echo.platinum.svc.cluster.local
          port:
            number: 80
          subset: v1
        weight: 100
    mirror:
      host: platinum-echo.platinum.svc.cluster.local
      subset: v2
      port:
        number: 80
    mirrorPercentage:
      value: 50
EOF
```

### Step 3: Create DestinationRule with Subsets

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: platinum-dr
  namespace: platinum
spec:
  host: platinum-echo.platinum.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
EOF
```

### Step 4: Verify Configuration

```bash
# Check VirtualService
kubectl get virtualservice -n platinum

# Check DestinationRule
kubectl get destinationrule -n platinum

# View mirror configuration
kubectl get virtualservice nginx-vs -n platinum -o yaml | grep -A 5 mirror
```

## Testing

### Test 1: Generate Traffic

```bash
for i in {1..10}; do
kubectl exec -n red sleep-red -- curl -s platinum-echo.platinum.svc.cluster.local/mars ;
done

kubectl logs -n platinum pods/platinum-echo-v1 | wc -l 
10
kubectl logs -n platinum pods/platinum-echo-v2 | wc -l 
5
```
