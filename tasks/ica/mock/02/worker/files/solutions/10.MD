# Task 10: Egress Gateway for External Traffic

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create ServiceEntry for External Service

First, register the external service in Istio's service registry:

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: ServiceEntry
metadata:
  name: echo-beeceptor
  namespace: emerald
spec:
  hosts:
  - echo.free.beeceptor.com
  ports:
  - number: 80
    name: http
    protocol: HTTP
  - number: 443
    name: https
    protocol: HTTPS
  location: MESH_EXTERNAL
  resolution: DNS
EOF
```

### Step 3: Create Gateway for Egress

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: echo-egress
  namespace: emerald
spec:
  selector:
    app: istio-egressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - echo.free.beeceptor.com
  - port:
      number: 443
      name: https
      protocol: TLS
    hosts:
    - echo.free.beeceptor.com
    tls:
      mode: PASSTHROUGH
EOF
```

### Step 4: Create DestinationRule for Egress Gateway

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: egressgateway-for-echo
  namespace: emerald
spec:
  host: istio-egressgateway.istio-system.svc.cluster.local
  subsets:
  - name: echo
EOF
```

### Step 5: Create VirtualService for Traffic Routing

This VirtualService handles the two-stage routing:
1. From mesh → route to egress gateway
2. From egress gateway → route to external service

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: echo-egress-vs
  namespace: emerald
spec:
  hosts:
  - echo.free.beeceptor.com
  gateways:
  - echo-egress
  - mesh
  http:
  - match:
    - gateways:
      - mesh
      port: 80
    route:
    - destination:
        host: istio-egressgateway.istio-system.svc.cluster.local
        subset: echo
        port:
          number: 80
      weight: 100
  - match:
    - gateways:
      - echo-egress
      port: 80
    route:
    - destination:
        host: echo.free.beeceptor.com
        port:
          number: 80
      weight: 100
EOF
```

### Step 6: Verify Configuration

```bash
# Check all resources
kubectl get serviceentry,gateway,virtualservice,destinationrule -n emerald

# Verify egress gateway pods are running
kubectl get pods -n istio-system -l app=istio-egressgateway

# Example output:
# NAME                                  READY   STATUS    RESTARTS   AGE
# istio-egressgateway-77fd648d9c-26v9p   1/1     Running   0          1h

# Verify the pod labels match Gateway selector
kubectl get pod -n istio-system -l app=istio-egressgateway -o jsonpath='{.items[0].metadata.labels}' | jq
# Should show: "app": "istio-egressgateway"
```

## Testing

### Test HTTP Access

```bash
# Use existing sleep-emerald pod
kubectl exec sleep-emerald -n emerald -- curl  http://echo.free.beeceptor.com
```

**Expected output:**
```
#Check it
"X-Envoy-Peer-Metadata-Id": "router~10.0.156.69~istio-egressgateway-77fd648d9c-26v9p.istio-system~istio-system.svc.cluster.local",
...
```

### Test HTTPS Access

```bash
# Test HTTPS
kubectl exec sleep-emerald -n emerald -- curl -I https://echo.free.beeceptor.com
```

### Verify Traffic Goes Through Egress Gateway

**Note about logging:** HTTPS traffic uses TLS PASSTHROUGH mode, which means the egress gateway forwards encrypted traffic without decrypting it. This results in minimal access logs since Envoy cannot inspect the HTTP headers.

To verify traffic is flowing through the egress gateway:

```bash
# Check egress gateway logs for connection activity
EGRESS_POD=$(kubectl get pod -n istio-system -l app=istio-egressgateway -o jsonpath='{.items[0].metadata.name}')

# Monitor logs while making request
kubectl logs -f -n istio-system $EGRESS_POD &

# Make HTTP request (will work if properly configured)
kubectl exec sleep-emerald -n emerald -- curl -I http://echo.free.beeceptor.com

# For HTTPS with PASSTHROUGH, you won't see detailed logs, but traffic flows through the gateway
kubectl exec sleep-emerald -n emerald -- curl -I https://echo.free.beeceptor.com

# Alternative verification: Check Envoy stats
kubectl exec -n istio-system $EGRESS_POD -- curl -s localhost:15000/stats | grep echo.free.beeceptor
```

**Why no detailed logs for HTTPS?**
- TLS PASSTHROUGH mode forwards encrypted traffic without terminating TLS
- The egress gateway acts as a TCP proxy for HTTPS traffic
- Detailed HTTP logs require TLS termination, which needs certificates for echo.free.beeceptor.com

## Verification Commands

```bash
# Verify ServiceEntry
kubectl get serviceentry echo-beeceptor -n emerald

# Verify Gateway
kubectl get gateway echo-egress -n emerald

# Verify VirtualService
kubectl get virtualservice echo-egress-vs -n emerald

# Verify DestinationRule
kubectl get destinationrule egressgateway-for-echo -n emerald

# Test connectivity
kubectl exec sleep-emerald -n emerald -- curl -I http://echo.free.beeceptor.com
```

## Summary

This configuration creates a complete egress gateway setup:

1. **ServiceEntry** - Registers echo.free.beeceptor.com as an external service in Istio's service registry
2. **Gateway** - Defines the egress gateway listener for both HTTP and HTTPS (PASSTHROUGH)
3. **VirtualService** - Two-stage routing:
   - Stage 1: Mesh sidecars route to egress gateway
   - Stage 2: Egress gateway routes to external service
4. **DestinationRule** - Defines the `echo` subset for the egress gateway

**Important Notes:**
- The VirtualService in Step 5 fixed the port from 443 to 80 for HTTP routing
- HTTPS uses TLS PASSTHROUGH, so you won't see detailed access logs
- The ServiceEntry is required to register the external service in Istio's registry
