# Task 04: Configure Request Timeout

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create VirtualService with 3-Second Timeout

The VirtualService must include both the short name (`white-echo`) for same-namespace requests and FQDN (`white-echo.white.svc.cluster.local`) for cross-namespace requests:

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: white-echo-vs
  namespace: white
spec:
  hosts:
    - white-echo.white.svc.cluster.local
  http:
    - timeout: 3s
      route:
        - destination:
            host: white-echo
            port:
              number: 80
EOF
```

**Important:**
- Timeout must be **3s** (not 2s)
- Use service port 80 (not container port 8080)
- Include both short name and FQDN in hosts to match all requests from within and outside the namespace
- The `/invincible` path has a **50% chance** of simulating a 5-second delay, so you may need to test multiple times to observe the timeout

### Step 3: Verify Configuration

```bash
# Check VirtualService exists
kubectl get virtualservice -n white

# View the timeout configuration
kubectl get virtualservice white-echo-vs -n white -o yaml | grep timeout
```

## Testing

### Test 1: Request Exceeding Timeout from Same Namespace (Should Return 504)

The `/invincible` path simulates a slow response that takes longer than 3 seconds:

```bash
# Test from within white namespace (this is what the actual test does)
kubectl exec sleep-black -n black -- curl -s -o /dev/null -w "%{http_code}" http://white-echo.white.svc.cluster.local/invincible
```

**Expected output:** `504` (Gateway Timeout)

### Test 2: Request Exceeding Timeout from Different Namespace (Should Return 504)

```bash
# Test from black namespace
kubectl exec sleep-black -n black -- curl -s -o /dev/null -w "%{http_code}" http://white-echo.white.svc.cluster.local/invincible
```

**Expected output:** `504` (Gateway Timeout)

### Test 3: Request Within Timeout (Should Succeed)

```bash
# Test with fast path (returns immediately, within 3s timeout)
kubectl exec sleep-black -n black -- curl -s -o /dev/null -w "%{http_code}" http://white-echo.white.svc.cluster.local/

# Should return 200 OK
```

**Note:**
- The `/invincible` path has a **50% chance** of a 5-second delay (exceeds the 3s timeout)
- If you test and get `200`, try again - you got the fast path
- The automated test retries up to 5 times to catch the timeout scenario
