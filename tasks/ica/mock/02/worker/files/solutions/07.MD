# Task 07: Expose Service via Istio Gateway

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create Istio Gateway

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: echo-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "echo.example.com"
EOF
```

### Step 3: Create VirtualService

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: copper-vs
  namespace: copper
spec:
  hosts:
  - copper-echo
  - "echo.example.com"
  gateways:
  - istio-system/echo-gateway
  http:
  - match:
    - uri:
        prefix: /
    route:
    - destination:
        host: copper-echo.copper.svc.cluster.local
        port:
          number: 80
EOF
```

### Step 4: Verify Configuration

```bash
# Check Gateway
kubectl get gateway -n istio-system 

# Check VirtualService
kubectl get virtualservice -n copper -o yaml

# Check if echo pods have sidecars (should show 2/2)
kubectl get pods -n copper -o yaml
```

### Test 1: Get Ingress Gateway Info

```bash
# Use the hosts command to get connection info
hosts
```

**Output example:**
```
==========================================
  Istio Ingress Gateway Info
==========================================
  Service Type: NodePort
  Node IP:      172.31.x.x
  HTTP Port:    31515

Test commands:
  curl http://echo.example.com:31515/nor
  curl -H 'Host: echo.example.com' http://172.31.x.x:31515/normandy
==========================================
```

### Test 2: Access via echo.example.com

```bash
# Get NodePort (or use hosts command)
NODE_PORT=$(kubectl get svc istio-demo-ingress -n istio-system -o jsonpath='{.spec.ports[?(@.port==80)].nodePort}')

# Test with echo.example.com
curl http://echo.example.com:$NODE_PORT/normandy

# Expected: JSON response with pod info
```

### Test 3: Test Different Endpoints

```bash
# Test /moon endpoint
curl http://echo.example.com:$NODE_PORT/moon

# Test /pluto endpoint
curl http://echo.example.com:$NODE_PORT/pluto

# Test root path
curl http://echo.example.com:$NODE_PORT/ -w "\nHTTP Code: %{http_code}\n"
```

### Test 4: Verify Gateway and VirtualService

```bash
# Check Gateway exists
kubectl get gateway echo-gateway -n istio-system

# Check VirtualService exists
kubectl get virtualservice copper-vs -n copper

# Check Gateway configuration
kubectl get gateway echo-gateway -n istio-system -o yaml
```
