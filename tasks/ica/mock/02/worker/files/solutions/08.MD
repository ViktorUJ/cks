# Task 08: Header-Based Routing

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create Gateway

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: ship-gateway
  namespace: istio-system
spec:
  selector:
    app: istio-demo-ingress
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "ship.milkyway.gal"
EOF
```

### Step 3: Create VirtualService with Header Matching

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: magenta-vs
  namespace: magenta
spec:
  hosts:
  - "ship.milkyway.gal"
  gateways:
  - istio-system/ship-gateway
  http:
  - match:
    - headers:
        commander:
          exact: shepard
    route:
    - destination:
        host: magenta-echo.magenta.svc.cluster.local
        port:
          number: 80
        subset: v1
  - route:
    - destination:
        host: magenta-echo.magenta.svc.cluster.local
        port:
          number: 80
        subset: v2
EOF
```
### Step 4: Create DestinationRule

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: magenta-dr
  namespace: magenta
spec:
  host: magenta-echo.magenta.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
EOF
```

### Step 5: Verify Configuration

```bash
# Check all resources
kubectl get gateway,virtualservice,destinationrule -n magenta
kubectl get gateway -n istio-system | grep ship

# View header matching configuration
kubectl get virtualservice magenta-vs -n magenta -o yaml | grep -A 5 headers

# Verify istio-demo-ingress service exists
kubectl get svc istio-demo-ingress -n istio-system
```

## Testing

### Test 1: Get Connection Info

```bash
# Use hosts command
hosts
```

### Test 2: Request with Matching Header (should go to v1)

```bash
# Get NodePort for istio-demo-ingress
NODE_PORT=$(kubectl get svc istio-demo-ingress -n istio-system -o jsonpath='{.spec.ports[?(@.port==80)].nodePort}')

# Test with commander: shepard header (should return v1)
curl -H "commander: shepard" http://ship.milkyway.gal:$NODE_PORT/normandy

# Expected output: v1 response
```

### Test 3: Request without Header (should go to v2)

```bash
# Test without header (should return v2)
curl http://ship.milkyway.gal:$NODE_PORT/normandy

# Expected output: v2 response
```

### Test 4: Multiple Requests to Verify Routing

```bash
# Test with header multiple times
echo "=== With header (v1) ==="
for i in {1..5}; do
  curl -H "commander: shepard" http://ship.milkyway.gal:$NODE_PORT/normandy
  echo ""
done

# Test without header multiple times
echo "=== Without header (v2) ==="
for i in {1..5}; do
  curl http://ship.milkyway.gal:$NODE_PORT/normandy
  echo ""
done
```

## Verification Commands

```bash
# Verify header matching configuration
kubectl get virtualservice magenta-vs -n magenta -o jsonpath='{.spec.http[0].match[0].headers}'

# Verify Gateway configuration
kubectl get gateway ship-gateway -n istio-system -o yaml

# Check DestinationRule subsets
kubectl get destinationrule magenta-dr -n magenta -o jsonpath='{.spec.subsets[*].name}'
```
