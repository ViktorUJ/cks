# Task 08: Header-Based Routing

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create Gateway

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: ship-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "ship.milkyway.gal"
EOF
```

### Step 3: Create VirtualService with Header Matching

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: magenta-vs
  namespace: magenta
spec:
  hosts:
  - magenta-echo
  - "ship.milkyway.gal"
  gateways:
  - istio-system/ship-gateway
  http:
  - match:
    - headers:
        commander:
          exact: shepard
    route:
    - destination:
        host: magenta-echo.magenta.svc.cluster.local
        port:
          number: 80
        subset: v1
  - route:
    - destination:
        host: magenta-echo.magenta.svc.cluster.local
        port:
          number: 80
        subset: v2
EOF
```
### Step 4: Create DestinationRule

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: magenta-dr
  namespace: magenta
spec:
  host: magenta-echo.magenta.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
EOF
```

### Step 5: Verify Configuration

```bash
# Check all resources
kubectl get gateway,virtualservice,destinationrule -n magenta
kubectl get gateway -n istio-system | grep ship

# View header matching configuration
kubectl get virtualservice magenta-vs -n magenta -o yaml | grep -A 5 headers
```

## Testing

### Test 1: Get Connection Info

```bash
# Use hosts command
hosts
```

### Test 2: Request with Matching Header (should go to v1)

```bash
# Get NodePort use hosts command
ubuntu@worker{TIME_UP}:/var/work/tests> hosts 
==========================================
  Istio Ingress Gateway Info
==========================================
  Service Type: NodePort
  Node IP:      10.10.2.160
  HTTP Port:    31515

Available hosts:
  - echo.example.com
  - ship.milkyway.gal

Test commands:
  curl http://echo.example.com:31515/mars
  curl http://ship.milkyway.gal:31515/normandy
  curl -H 'commander: shepard' http://ship.milkyway.gal:31515/normandy

# Test with commander: shepard header (should return "welcome aboard capitan")
curl -H "commander: shepard" http://ship.milkyway.gal:31515/normandy

# Expected output: welcome aboard capitan
```

### Test 3: Request without Header (should go to v2)

```bash
# Test without header (should return "Normandy SR2")
curl http://ship.milkyway.gal:$NODE_PORT/normandy

# Expected output: Normandy SR2
```

### Test 4: Multiple Requests to Verify Routing

```bash
# Test with header multiple times
echo "=== With header (v1) ==="
for i in {1..5}; do
  curl -H "commander: shepard" http://ship.milkyway.gal:$NODE_PORT/normandy
  echo ""
done

# Test without header multiple times
echo "=== Without header (v2) ==="
for i in {1..5}; do
  curl http://ship.milkyway.gal:$NODE_PORT/normandy
  echo ""
done
```

## Verification Commands

```bash
# Verify header matching configuration
kubectl get virtualservice magenta-vs -n magenta -o jsonpath='{.spec.http[0].match[0].headers}'

# Verify Gateway configuration
kubectl get gateway ship-gateway -n istio-system -o yaml

# Check DestinationRule subsets
kubectl get destinationrule magenta-dr -n magenta -o jsonpath='{.spec.subsets[*].name}'
```
