# Task 14: Configure External Access for Echo Service

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Edit Gateway

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: echo-gateway
  namespace: silver
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - test.gateway.ica
EOF
```

### Step 3: Edit VirtualService

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: echo-vs
  namespace: silver
spec:
  hosts:
  - test.gateway.ica
  gateways:
  - echo-gateway
  http:
  - route:
    - destination:
        host: echo-silver.silver.svc.cluster.local
        port:
          number: 80
EOF
```

### Step 4: Verify Configuration

```bash
# Check Gateway
kubectl get gateway -n silver
kubectl describe gateway echo-gateway -n silver

# Check VirtualService
kubectl get virtualservice -n silver
kubectl describe virtualservice echo-vs -n silver
```

## Testing

```bash
# Use the hosts command to see connection info
hosts

# Get NodePort
NODE_PORT=$(kubectl get svc istio-demo-ingress -n istio-system --context cluster3-admin@cluster3 -o jsonpath='{.spec.ports[?(@.port==80)].nodePort}')

# Test via ingress gateway with NodePort (test.gateway.ica is in /etc/hosts)
curl http://test.gateway.ica:$NODE_PORT/

# Expected: JSON response with pod info
# {"pod_name":"echo-silver-xxx","version":"v1","namespace":"silver","space_object":""}
```
