# Task 03: Deny All Traffic with AuthorizationPolicy

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Ensure Istio Injection is Enabled

AuthorizationPolicy only works with Istio sidecars. Enable injection for the violet namespace:

```bash
# Check if namespace has injection enabled
kubectl get namespace violet --show-labels

# If istio-injection=enabled is not present, enable it
kubectl label namespace violet istio-injection=enabled --overwrite

# Restart pods to inject sidecars
kubectl rollout restart deployment -n violet
```

### Step 3: Create Deny-All AuthorizationPolicy

```bash
kubectl apply -f - <<'EOF'
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: deny-all
  namespace: violet
spec: {}
EOF
```

**Note:** An empty `spec: {}` creates a deny-all policy. This denies all requests to workloads in the violet namespace.

### Step 3: Verify Configuration

```bash
# Check the policy exists
kubectl get authorizationpolicy -n violet

```

## Testing

### Test 1: Access from Same Namespace (Should Fail)

```bash
# Run a test pod in violet namespace
kubectl run violet-sleep -n violet --image=curlimages/curl -- sleep 3600

# Try to access violet-echo (should fail with 403 or connection refused)
kubectl exec violet-sleep -n violet -- curl -s -o /dev/null -w "%{http_code}\n" http://violet-echo.violet.svc.cluster.local:8080/mars
```

Expected output: `000` (connection failed)

### Test 2: Access from Different Namespace (Should Fail)

```bash
# Run a test pod in black namespace
kubectl exec sleep-black -n black -- curl -s -o /dev/null -w "%{http_code}\n" http://violet-echo.violet.svc.cluster.local:8080/mars
```

Expected output: `000` (connection failed)
