# Task 02: Configure Sidecar to Allow Egress Connections

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```
### Step 2: Create Sidecar Configuration

The Sidecar resource will restrict egress traffic to only the specified namespaces.

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: default
  namespace: black
spec:
  egress:
  - hosts:
    - "./*"                    # Current namespace (black)
    - "green/*"                # All services in green namespace
    - "istio-system/*"         # All services in istio-system namespace
    - "*/echo.free.beeceptor.com"
EOF
```

### Step 3: Verify Configuration

```bash

# Check the configuration
kubectl get sidecar default -n black -o yaml
```
#### Test 1: Communication within black namespace

```bash
# If you have a test pod in black namespace
kubectl exec -n black sleep-black -- curl http://black-echo-service:8080/sun
```

#### Test 2: Communication to green namespace

```bash
# Test connectivity to green namespace service
kubectl exec -n black sleep-black -- curl http:/green-echo-service.green.svc.cluster.local:8080/sun
```

#### Test 3: Communication to istio-system namespace

```bash
# Test connectivity to istio-system services
kubectl exec -n black sleep-black -- curl http://istiod.istio-system.svc.cluster.local:15014/version
```

#### Test 4: Verify blocked traffic (to other namespaces)

```bash
# Try to access a service in a namespace NOT in the egress list
# This should fail or timeout if there's a service in another namespace
kubectl exec -n black sleep-black -- curl http://echo-version-v1.blue.svc.cluster.local:8080/sun --max-time 5
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:--  0:00:05 --:--:--     0
curl: (28) Operation timed out after 5001 milliseconds with 0 bytes received
command terminated with exit code 28
# Or no no strict mode  is set =)
# https://istio.io/latest/docs/reference/config/networking/sidecar/#OutboundTrafficPolicy-Mode-REGISTRY_ONLY 
# BUT its not required to set it to REGISTRY_ONLY in ex
```
