# Task 09: Selective Sidecar Injection

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Check Current State

```bash
# Check existing resources
kubectl get ns turquoise --show-labels
kubectl get all -n turquoise

# The turquoise-echo deployment and sleep-turquoise pod should exist
# Both should have 1/1 containers (no sidecars yet)
```

### Step 3: Enable Namespace-Level Injection

```bash
# Enable automatic injection for the namespace
kubectl label namespace turquoise istio-injection=enabled

# Verify
kubectl get ns turquoise --show-labels
# Should show: istio-injection=enabled
```

### Step 4: Disable Injection for turquoise-echo Deployment

```bash
# Patch the deployment to disable sidecar injection using annotation
kubectl patch deployment turquoise-echo -n turquoise -p '{
  "spec": {
    "template": {
      "metadata": {
        "annotations": {
          "sidecar.istio.io/inject": "false"
        }
      }
    }
  }
}'

# Wait for rollout to complete
kubectl rollout status deployment turquoise-echo -n turquoise
```

### Step 5: Recreate sleep-turquoise Pod for Injection

```bash
# Delete the sleep-turquoise pod so it gets recreated with sidecar
kubectl delete pod sleep-turquoise -n turquoise

# Wait for pod to be recreated (it's a standalone pod, needs to be recreated from manifest)
# Or apply the manifest again:
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: sleep-turquoise
  namespace: turquoise
  labels:
    app: sleep-turquoise
spec:
  containers:
  - name: sleep-turquoise
    image: curlimages/curl
    command: ["/bin/sh", "-c", "sleep 3600"]
    resources:
      requests:
        cpu: "10m"
        memory: "32Mi"
      limits:
        cpu: "50m"
        memory: "64Mi"
EOF
```

### Step 6: Verify Configuration

```bash
# Check all pods in turquoise namespace
kubectl get pods -n turquoise

# Expected output:
# NAME                              READY   STATUS    RESTARTS   AGE
# turquoise-echo-xxx                1/1     Running   0          1m
# sleep-turquoise                   2/2     Running   0          30s

# turquoise-echo should have 1/1 (no sidecar due to annotation)
# sleep-turquoise should have 2/2 (has sidecar from namespace injection)
```

## Verification Commands

```bash
# Verify namespace has injection enabled
kubectl get namespace turquoise -o jsonpath='{.metadata.labels.istio-injection}'
# Expected: enabled

# Verify turquoise-echo deployment has exclusion annotation
kubectl get deployment turquoise-echo -n turquoise -o jsonpath='{.spec.template.metadata.annotations.sidecar\.istio\.io/inject}'
# Expected: false

# Check containers in turquoise-echo pod
kubectl get pod -n turquoise -l app=turquoise-echo -o jsonpath='{.items[0].spec.containers[*].name}'
# Expected: echo (only one container)

# Check containers in sleep-turquoise pod
kubectl get pod sleep-turquoise -n turquoise -o jsonpath='{.spec.containers[*].name}'
# Expected: sleep-turquoise istio-proxy (two containers)

# Verify container counts
TURQUOISE_ECHO_COUNT=$(kubectl get pod -n turquoise -l app=turquoise-echo -o jsonpath='{.items[0].spec.containers[*].name}' | wc -w)
SLEEP_COUNT=$(kubectl get pod sleep-turquoise -n turquoise -o jsonpath='{.spec.containers[*].name}' | wc -w)
echo "turquoise-echo containers: $TURQUOISE_ECHO_COUNT (should be 1)"
echo "sleep-turquoise containers: $SLEEP_COUNT (should be 2)"
```
