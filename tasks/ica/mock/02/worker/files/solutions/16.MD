# Task 16: DestinationRule with Port-Level Load Balancing

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create DestinationRule

**IMPORTANT:** The task requires the DestinationRule to be named `example-dr` (per README line 195).

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: example-dr
  namespace: maroon
spec:
  host: maroon-svc
  trafficPolicy:
    loadBalancer:
      simple: ROUND_ROBIN
    portLevelSettings:
    - port:
        number: 443
      loadBalancer:
        simple: LEAST_CONN
EOF
```

## Verification

```bash
# Check DestinationRule
kubectl get destinationrule -n maroon
kubectl describe destinationrule example-dr -n maroon

# View full configuration
kubectl get destinationrule example-dr -n maroon -o yaml
```

## Testing

**Note:** Load balancing algorithms only show differences when there are multiple backend pods. With a single pod, all requests go to the same pod regardless of the algorithm.

```bash
# First, verify the service name
kubectl get svc -n maroon

# Test HTTP traffic (port 80 - should use ROUND_ROBIN global default)
for i in {1..10}; do
  kubectl exec -n maroon sleep-maroon -- curl -s http://maroon-svc 2>/dev/null
done | jq -r .pod_name | sort | uniq -c

# Test HTTPS traffic (port 443 - should use LEAST_CONN)
for i in {1..10}; do
  kubectl exec -n maroon sleep-maroon -- curl -s -k https://maroon-svc 2>/dev/null
done | jq -r .pod_name | sort | uniq -c

# Note: Load balancing distribution only varies with multiple replicas
# Scale the deployment to see different patterns:
# kubectl scale deployment maroon-* -n maroon --replicas=3
```
