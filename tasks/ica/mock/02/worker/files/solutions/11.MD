# Task 11: Configure VirtualService for Gateway Routing

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create Gateway (if not exists)

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: demo-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "app.domain.com"
    - "*"
EOF
```

### Step 3: Create VirtualService

```bash
kubectl apply -f - <<'EOF'
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: sapphire-vs
  namespace: sapphire
spec:
  hosts:
  - "app.domain.com"
  gateways:
  - istio-system/demo-gateway
  http:
  - match:
    - uri:
        prefix: /moon
    route:
    - destination:
        host: echo.sapphire.svc.cluster.local
        port:
          number: 80
EOF
```

### Step 4: Verify Configuration

```bash
# Check Gateway
kubectl get gateway demo-gateway -n istio-system

# Check VirtualService
kubectl get virtualservice -n sapphire
kubectl describe virtualservice sapphire-vs -n sapphire
```

## Testing

```bash
# Use the hosts command to see connection info
hosts

# Get NodePort
NODE_PORT=$(kubectl get svc istio-demo-ingress -n istio-system --context cluster3-admin@cluster3 -o jsonpath='{.spec.ports[?(@.port==80)].nodePort}')

# Test via ingress gateway with NodePort (app.domain.com is in /etc/hosts)
curl http://app.domain.com:$NODE_PORT/moon

# Expected: Echo response from echo service

# Test wrong path (should 404 or fail)
curl http://app.domain.com:$NODE_PORT/other

# Alternative: Use -H flag if /etc/hosts not configured
NODE_IP=$(kubectl get nodes --context cluster3-admin@cluster3 -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
curl -H "Host: app.domain.com" http://$NODE_IP:$NODE_PORT/moon
```
