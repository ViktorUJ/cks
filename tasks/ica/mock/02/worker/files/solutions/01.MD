# Task 01: Install Istio with Helm

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster1-admin@cluster1
```

### Step 2: Install Istio Base Chart

```bash
# Install Istio base components (CRDs and cluster-wide resources)
helm install istio-base istio/base -n istio-system  --create-namespace --version 1.26.3
```

### Step 3: Create Values File for Istiod

Create a values file for istiod with custom pilot resources:

TIP: Optionally you can use `helm show values istio/istiod` to see all available values and their default values.

```bash
cat <<'EOF' > /tmp/istiod-values.yaml
pilot:
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 100m
      memory: 256Mi

profile: demo
EOF
```

### Step 4: Install Istiod (Control Plane)

```bash
# Install istiod with custom values
helm install istiod istio/istiod -n istio-system  -f /tmp/istiod-values.yaml --version 1.26.3
```

### Step 5: Prepare Gateway Chart (Fix Broken Schema)

**IMPORTANT:** The gateway Helm chart 1.26.3 has a broken schema file (`values.schema.json`) with `"additionalProperties": false` at the root level, causing ALL installations to fail. Fix by downloading and removing the schema:

```bash
# Download gateway chart locally
helm pull istio/gateway --version 1.26.3 --untar -d /tmp/

# Remove the broken schema file
rm /tmp/gateway/values.schema.json
```

### Step 6: Create Gateway Values Files

```bash
# Ingress gateway values
cat <<'EOF' > /tmp/ingress-gateway-values.yaml
name: istio-demo-ingress
service:
  type: NodePort
replicaCount: 1
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 2000m
    memory: 1024Mi
autoscaling:
  enabled: false
EOF

# Egress gateway values
cat <<'EOF' > /tmp/egress-gateway-values.yaml
name: istio-demo-egress
service:
  type: ClusterIP
replicaCount: 1
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 2000m
    memory: 1024Mi
autoscaling:
  enabled: false
EOF
```

### Step 7: Install Gateways from Local Chart

```bash
# Install ingress gateway
helm install istio-demo-ingress /tmp/gateway -n istio-system -f /tmp/ingress-gateway-values.yaml

# Install egress gateway
helm install istio-demo-egress /tmp/gateway -n istio-system -f /tmp/egress-gateway-values.yaml
```

### Step 8: Verify Installation

```bash
# Check namespace
kubectl get namespace istio-system

# Check Helm releases (should show istio-base and istiod)
helm list -n istio-system

# Check all deployments (should show istiod, istio-demo-ingress, istio-demo-egress)
kubectl get deployments -n istio-system

# Check all pods are running
kubectl get pods -n istio-system
```

### Step 9: Validate Specific Requirements

```bash
# Verify istiod replica count (should be 1)
kubectl get deployment istiod -n istio-system -o jsonpath='{.spec.replicas}' && echo

# Verify istiod CPU request (should be 100m)
kubectl get deployment istiod -n istio-system -o jsonpath='{.spec.template.spec.containers[0].resources.requests.cpu}' && echo

# Verify istiod memory request (should be 256Mi)
kubectl get deployment istiod -n istio-system -o jsonpath='{.spec.template.spec.containers[0].resources.requests.memory}' && echo

# Verify istiod CPU limit (should be 100m)
kubectl get deployment istiod -n istio-system -o jsonpath='{.spec.template.spec.containers[0].resources.limits.cpu}' && echo

# Verify istiod memory limit (should be 256Mi)
kubectl get deployment istiod -n istio-system -o jsonpath='{.spec.template.spec.containers[0].resources.limits.memory}' && echo

# Verify gateway deployments exist
kubectl get deployment istio-demo-ingress -n istio-system
kubectl get deployment istio-demo-egress -n istio-system

# Verify Helm chart version
helm list -n istio-system -o json | grep -E '"chart":"(base|istiod)-1.26.3"'
```

## Summary

**Installed components:**
- ✅ istio-base 1.26.3 (Helm)
- ✅ istiod 1.26.3 (Helm) with custom pilot resources (cpu: 100m, memory: 256Mi)
- ✅ istio-demo-ingress gateway (Helm - installed from local chart with schema removed)
- ✅ istio-demo-egress gateway (Helm - installed from local chart with schema removed)

**Why local chart installation?**
The gateway Helm chart 1.26.3 has a broken schema file (`values.schema.json`) with `"additionalProperties": false` at the root level. This causes the schema to reject ALL configuration values, including valid ones from the chart's own documentation.

**Solution:** Download the chart locally, remove the broken schema file, and install from the local chart path. This is still a pure Helm installation - we're just fixing the upstream bug by removing the faulty schema validation.
