# Task 06: Traffic Splitting (Canary Deployment)

### Step 1: Switch to Correct Context

```bash
kubectl config use-context cluster3-admin@cluster3
```

### Step 2: Create VirtualService with Traffic Splitting

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: gold-vs
  namespace: gold
spec:
  hosts:
  - gold-echo
  gateways:
  - istio-system/app-gateway
  http:
  - match:
      - uri:
          prefix: /
    route:
    - destination:
        host: gold-echo.gold.svc.cluster.local
        port:
          number: 80
        subset: v1
      weight: 50
    - destination:
        host: gold-echo.gold.svc.cluster.local
        port:
          number: 80
        subset: v2
      weight: 50
EOF
```

### Step 3: Create DestinationRule with Subsets

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: gold-dr
  namespace: gold
spec:
  host: gold-echo
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
EOF
```

### Step 4: Verify Configuration

```bash
# Check VirtualService
kubectl get virtualservice -n gold -o yaml

# Check DestinationRule
kubectl get destinationrule -n gold -o yaml

```

## Testing

### Test Traffic Distribution

```bash
# Run multiple requests and count responses
for i in {1..10}; do
  kubectl exec -n gold sleep-gold -- curl -s http://gold-echo/moon
done | sort 

```
